#!/usr/bin/env bash
# aqua-installer - shell script to install aqua
# https://github.com/aquaproj/aqua-installer

set -eu
set -o pipefail || :

usage_exit() {
	echo "Usage: $0 [-v version]" 1>&2
	exit 1
}

uname_os() {
	local os
	os=$(uname -s | tr '[:upper:]' '[:lower:]')
	case "$os" in
		cygwin_nt*) os="windows" ;;
		mingw*) os="windows" ;;
		msys_nt*) os="windows" ;;
	esac
	echo "$os"
}

uname_arch() {
	local arch
	arch=$(uname -m)
	case $arch in
		x86_64) arch="amd64" ;;
		aarch64) arch="arm64" ;;
	esac
	echo "${arch}"
}

OS="$(uname_os)"
ARCH="$(uname_arch)"

install_path=${AQUA_ROOT_DIR:-${XDG_DATA_HOME:-$HOME/.local/share}/aquaproj-aqua}/bin/aqua
if [ "$OS" = windows ]; then
	install_path=${AQUA_ROOT_DIR:-$HOME/AppData/Local/aquaproj-aqua}/bin/aqua.exe
fi

while getopts v: OPT
do
	case $OPT in
		v) AQUA_VERSION=$OPTARG
			;;
		\?) usage_exit
			;;
	esac
done

shift $((OPTIND - 1))

bootstrap_version=v2.53.10
checksums="fb75c6b255ae9e7a5d0a2329b6c0f35b60eb4d95c1f838367ca8245ce2fb3c2b  aqua_darwin_amd64.tar.gz
c3b9a6fe53b6f6b4b5ea7305d78565485f83fcdfe104fbd4926d5dd30ad94276  aqua_darwin_arm64.tar.gz
5ff77fa8635ea16818bcc2098f8aaaf7099d6260ca13471adacebe031e4c7b06  aqua_linux_amd64.tar.gz
62b8ea87be0b61c449596fbec3fc0410fc8bcb8e263ec34a497b9258f9d253b5  aqua_linux_arm64.tar.gz
69397f22ed6dbf748390e50e902d8c7711855b9e88cbdc83ebce6a72f6c8c5c8  aqua_windows_amd64.zip
f65e6c85f18799eb2487a6bf33c06a6ad34418e9c6f2808a74e40b7ca35c3916  aqua_windows_arm64.zip"

filename=aqua_${OS}_${ARCH}.tar.gz
if [ "$OS" = windows ]; then
	filename=aqua_${OS}_${ARCH}.zip
fi
URL=https://github.com/aquaproj/aqua/releases/download/$bootstrap_version/$filename

tempdir=$(mktemp -d)
echo "[INFO] Installing aqua $bootstrap_version for bootstrapping..." >&2
echo "[INFO] Downloading $URL ..." >&2
if command -v curl > /dev/null 2>&1; then
	curl --retry 5 --fail -L "$URL" -o "$tempdir/$filename"
elif command -v wget > /dev/null 2>&1; then
	wget -P "$tempdir" "$URL"
else
	echo "[ERROR] Neither curl nor wget is found. Please install either curl or wget to download aqua" >&2
	exit 1
fi

cd "$tempdir"

echo "[INFO] Verifying checksum of aqua $bootstrap_version ..." >&2
if command -v sha256sum > /dev/null 2>&1; then
	echo "$checksums" | grep "$filename" | sha256sum -c -
elif command -v shasum > /dev/null 2>&1; then
	echo "$checksums" | grep "$filename" | shasum -a 256 -c
else
	echo "[WARN] Skipped checksum verification of aqua $bootstrap_version because both sha256sum and shasum commands aren't found" >&2
fi

if [ "$OS" = windows ]; then
	unzip "$filename" > /dev/null
else
	tar xvzf "$filename" > /dev/null
fi
chmod a+x aqua
if [ -n "${AQUA_VERSION:-}" ]; then
	echo "[INFO] $tempdir/aqua update-aqua $AQUA_VERSION" >&2
	./aqua update-aqua "$AQUA_VERSION"
else
	echo "[INFO] $tempdir/aqua update-aqua" >&2
	./aqua update-aqua
fi

echo ""
echo "==============================================================="
echo "[INFO] aqua is installed into $install_path" >&2
echo '[INFO] Please add the path to the environment variable "PATH"' >&2
# shellcheck disable=SC2016
install_dir='${AQUA_ROOT_DIR:-${XDG_DATA_HOME:-$HOME/.local/share}/aquaproj-aqua}/bin'
if [ "$OS" = windows ]; then
	# shellcheck disable=SC2016
	install_dir='${AQUA_ROOT_DIR:-$HOME/AppData/Local/aquaproj-aqua}/bin'
fi
echo "[INFO] export PATH=$install_dir:\$PATH" >&2
echo "==============================================================="
echo ""

"$install_path" -v

rm -R "$tempdir"
